<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>D&D VTT Maps</title>
    <!--   Usability   -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!--  Robots    -->
    <meta
      name="description"
      content="Virtual tabletop maps for FoundryVTT and other similar VTT software!"
    />
    <meta name="robots" content="index, follow" />

    <!--  SEO   -->
    <meta
      name="keywords"
      content="OpenGraph, meta tags, find-ability, Twitter, Facebook, SEO"
    />
    <meta
      name="description"
      content="This website hold a catalogue of all maps utilized in the Boop Ninja Universe and associated campaigns."
    />

    <meta property="og:title" content="VTT Maps by Boop Ninja Universe" />
    <meta property="og:url" content="https://vtt-maps.dnd-apps.dev/" />
    <meta
      property="og:image"
      content="https://avatars.githubusercontent.com/u/51458697?s=200&v=4"
    />
    <meta
      property="og:description"
      content="This website hold a catalogue of all maps utilized in the Boop Ninja Universe and associated campaigns."
    />
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="VTT Maps by Boop NInja Universe" />
    <meta
      name="twitter:image"
      content="https://avatars.githubusercontent.com/u/51458697?s=200&v=4"
    />
    <meta
      property="twitter:description"
      content="This website hold a catalogue of all maps utilized in the Boop Ninja Universe and associated campaigns."
    />

    <!--  Styles  -->
    <link data-trunk rel="scss" href="src/styles/index.scss" />

    <!--  Files to Copy  -->
    <link
      data-trunk
      rel="icon"
      type="image/x-icon"
      href="../../assets/vtt-maps-logo.png"
    />
    <link data-trunk rel="copy-file" href="../../README.md" />
    <link data-trunk rel="copy-file" href="../../config/CNAME" />
    <link data-trunk rel="copy-dir" href="../../assets" />
    <script defer>
      sessionStorage.setItem("catalog-downloading", JSON.stringify([]));

      function addToQueue(path) {
        let queue = JSON.parse(sessionStorage.getItem("catalog-downloading"));
        queue.push(path);
        sessionStorage.setItem("catalog-downloading", JSON.stringify(queue));
      }

      function isInQueue(path) {
        let queue = JSON.parse(sessionStorage.getItem("catalog-downloading"));
        return queue.includes(path);
      }

      function removeFromQueue(path) {
        let queue = JSON.parse(sessionStorage.getItem("catalog-downloading"));
        queue = queue.filter((item) => item !== path);
        sessionStorage.setItem("catalog-downloading", JSON.stringify(queue));
      }

      function handleDownload(path) {
        if (isInQueue(path)) {
          return;
        }

        addToQueue(path);
        let blob;
        let request = new XMLHttpRequest();
        request.open("GET", path, true);
        request.responseType = "blob";
        request.onprogress = (event) => {
          console.log(event);
        };
        request.onload = function (e) {
          blob = new Blob([this.response]);
        };
        request.onloadend = function (e) {
          let fileName = path.split("/").pop();
          let tempEl = document.createElement("a");
          document.body.appendChild(tempEl);
          tempEl.style = { display: "none" };
          path = window.URL.createObjectURL(blob);
          tempEl.href = path;
          tempEl.download = fileName;
          tempEl.click();
          window.URL.revokeObjectURL(path);
          removeFromQueue(path);
        };
        request.send();
      }

      function waitForElementById(id) {
        return new Promise((resolve, reject) => {
          let interval = setInterval(() => {
            if (document.getElementById(id)) {
              clearInterval(interval);
              resolve();
            }
          }, 100);
        });
      }

      async function loader() {
        await waitForElementById("catalog");
        await waitForElementById("map-asset-vcc");
        setTimeout(() => {
          document.querySelectorAll("button[data-href]").forEach((element) => {
            element.setAttribute("data-processed", "true");
            element.onclick = () =>
              handleDownload(element.getAttribute("data-href"));
          });
        }, 250);
      }

      loader().then(() => {
        document
          .getElementById("catalog")
          .setAttribute("data-processed", "true");
        document.getElementById("catalog").setAttribute("data-trunk", "true");
        document
          .getElementById("map-asset-vcc")
          .setAttribute("data-trunk", "true");
      });

      // // wait for the element #catalog to appear
      // let interval = setInterval(() => {
      //   if (document.getElementById("catalog")) {
      //     clearInterval(interval);
      //     document
      //       .getElementById("catalog")
      //       .setAttribute("data-processed", "true");
      //     document.getElementById("catalog").setAttribute("data-trunk", "true");
      //     map-asset-vcc
      //
      //
      //   }
      // }, 100);
    </script>
  </head>
</html>
